name: Cleanup merged codex/copilot branches

on:
  # Run once per day (04:00 UTC); adjust as needed
  schedule:
    - cron: "0 4 * * *"
  # Allow manual trigger from the Actions tab
  workflow_dispatch:

permissions:
  contents: write   # required to delete branches

jobs:
  delete_merged_branches:
    name: Delete codex/copilot branches merged > 2 days ago
    runs-on: ubuntu-latest

    steps:
      - name: Install jq (for JSON parsing)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Delete old merged codex/ and copilot/ branches
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          OWNER="${REPO%/*}"
          REPO_NAME="${REPO#*/}"

          echo "Scanning branches in $OWNER/$REPO_NAME ..."

          # seconds in 2 days
          TWO_DAYS_SECONDS=$((2 * 24 * 60 * 60))
          NOW_TS=$(date -u +%s)

          page=1
          while :; do
            echo "Fetching branches page $page..."
            RESPONSE=$(curl -sS \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$OWNER/$REPO_NAME/branches?per_page=100&page=$page")

            COUNT=$(echo "$RESPONSE" | jq 'length')
            if [ "$COUNT" -eq 0 ]; then
              echo "No more branches to process."
              break
            fi

            echo "$RESPONSE" | jq -r '.[].name' | while read -r BRANCH; do
              if [[ "$BRANCH" == codex/* || "$BRANCH" == copilot/* ]]; then
                echo "Processing branch: $BRANCH"

                # Find closed PRs with this branch as the head
                PRS=$(curl -sS \
                  -H "Authorization: Bearer $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/$OWNER/$REPO_NAME/pulls?state=closed&head=$OWNER:$BRANCH&per_page=10")

                # Get the first merged PR's merged_at (if any)
                MERGED_AT=$(echo "$PRS" | jq -r '[.[] | select(.merged_at != null)][0].merged_at // empty')

                if [ -z "$MERGED_AT" ]; then
                  echo "  → No merged PR found for $BRANCH (skipping)."
                  continue
                fi

                MERGED_TS=$(date -d "$MERGED_AT" +%s)
                AGE_SECONDS=$((NOW_TS - MERGED_TS))

                if [ "$AGE_SECONDS" -ge "$TWO_DAYS_SECONDS" ]; then
                  echo "  → Branch $BRANCH was merged at $MERGED_AT (>= 2 days ago). Deleting..."

                  DELETE_STATUS=$(curl -sS -o /dev/null -w "%{http_code}" \
                    -X DELETE \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    "https://api.github.com/repos/$OWNER/$REPO_NAME/git/refs/heads/$BRANCH")

                  if [ "$DELETE_STATUS" -eq 204 ]; then
                    echo "  ✓ Successfully deleted branch $BRANCH"
                  else
                    echo "  ✗ Failed to delete branch $BRANCH (HTTP $DELETE_STATUS)"
                  fi
                else
                  echo "  → Branch $BRANCH merged less than 2 days ago (skipping for now)."
                fi
              fi
            done

            page=$((page + 1))
          done
